# CLAUDE.md — WSL Cleaner

## Project Overview

WSL Cleaner is a desktop Electron application for Windows 10/11 that cleans, optimizes, and compacts WSL 2 virtual disks. It provides a Simple one-click mode and an Advanced mode with granular control over 40+ cleanup tasks, a stale directory scanner, VHDX disk compaction, and a Health Dashboard with real-time system metrics.

## Tech Stack

- **Runtime:** Electron (Node.js main + Chromium renderer)
- **Language:** Plain JavaScript (CommonJS in Node, vanilla JS in renderer). No TypeScript, no frameworks.
- **Styling:** Single `renderer/styles.css`, dark theme, CSS custom properties
- **Charts:** Chart.js (bundled as `renderer/chart.umd.min.js`)
- **Build:** electron-builder (NSIS installer for Windows)
- **Tests:** Vitest (`npm test`)

## Architecture

```
Electron Main Process (Node.js)
  ├── main.js              # Window lifecycle, IPC handlers, auto-updater
  ├── lib/wsl-ops.js       # WSL command execution, VHDX discovery, stale scanning, disk usage, health, distro management
  ├── lib/utils.js         # parseWslOutput, friendlyError, exitCodeHint, STALE_DIR_NAMES
  ├── lib/stats-db.js      # Cleanup history persistence (JSON file)
  └── lib/preferences.js   # Task toggle + locale preference persistence

Preload Bridge
  └── preload.js           # contextBridge exposing window.wslCleaner API

Renderer Process (Browser)
  ├── renderer/index.html  # App shell with data-i18n attributes
  ├── renderer/i18n.js     # i18n module (t, tp, tError, applyI18n, setLocale)
  ├── renderer/utils.js    # formatBytes, escapeHtml, estimateTotalSize, exitCodeHint
  ├── renderer/tasks.js    # TASKS array (40+ cleanup task definitions)
  ├── renderer/treemap.js  # Squarified treemap layout algorithm & DOM renderer
  ├── renderer/app.js      # All UI logic, state management, task orchestration
  └── renderer/styles.css  # All styling

Locales
  ├── locales/en.json          # Source-of-truth English strings
  ├── locales/languages.json   # Language registry
  └── locales/{code}.json      # Translated locale files (auto-generated)

Tests
  └── tests/*.test.js          # Vitest test files
```

## Critical Rules

### Localization — DO NOT edit non-English locale files

**Only edit `locales/en.json`.** All other locale files (`fr.json`, `de.json`, `es.json`, `zh.json`, `hi.json`, `pt.json`) are auto-generated by `npm run translate` (uses OpenAI API). Never manually edit them — your changes will be overwritten.

When adding new translatable strings:
1. Add the key and English value to `locales/en.json`
2. Use `t('your.key')` in JS or `data-i18n="your.key"` in HTML
3. The translation script handles all other languages

### Security — never weaken these

- `nodeIntegration: false`, `contextIsolation: true` — never change
- CSP restricts scripts to `'self'`
- All renderer access to Node/Electron goes through `window.wslCleaner` (preload bridge)

## Conventions

- **No frameworks** — vanilla HTML/CSS/JS in the renderer
- **No TypeScript** — plain CommonJS JavaScript throughout
- **`const`/`let`** only, no `var`
- **`async`/`await`** preferred over raw Promise chains
- **Section comments** in large files: `// ── Section Name ──────...`
- **Commit messages:** conventional style (`feat:`, `fix:`, `docs:`, `refactor:`)

## IPC Pattern

All main↔renderer communication uses `ipcMain.handle` / `ipcRenderer.invoke` (async request/response). Streaming task output is pushed via `webContents.send('task-output', ...)`.

## i18n Conventions

- **Flat keys with dot notation:** `"section.subsection.element"`
- **Plurals:** `_one` / `_other` suffixes
- **Placeholders:** `{name}` syntax
- **HTML in values:** Allowed for keys using `data-i18n-html`
- **Fallback chain:** Current locale → English → raw key string
- **Task names/descriptions:** Use computed keys `t('task.' + task.id + '.name')`

## Common Commands

```bash
npm test           # Run all tests
npm run test:watch # Watch mode
npm run build      # Create NSIS installer in dist/
npm run translate  # Generate translations for all languages (requires OPENAI_API_KEY)
```

## Keeping Docs in Sync

When making structural changes (adding/removing/renaming files, new test files, architecture changes), update:
1. **`AGENTS.md`** — Architecture diagram, File Responsibilities table
2. **`README.md`** — Project Structure section
3. **`CONTRIBUTING.md`** — Project Structure tree, layer/responsibility table
