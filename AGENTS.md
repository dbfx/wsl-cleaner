# AGENTS.md — WSL Cleaner

## Project Overview

WSL Cleaner is a desktop Electron application for Windows 10/11 that cleans, optimizes, and compacts WSL 2 (Windows Subsystem for Linux) virtual disks. It provides a Simple one-click mode and an Advanced mode with granular control over 40+ cleanup tasks, a stale directory scanner, and VHDX disk compaction via `Optimize-VHD`.

Target audience: developers running WSL 2 with large virtual disk images who want to reclaim SSD space.

## Tech Stack

- **Runtime:** Electron (Node.js main process + Chromium renderer)
- **Language:** Plain JavaScript (CommonJS in Node, vanilla JS in renderer). No TypeScript, no frameworks.
- **Styling:** Single `renderer/styles.css` file, dark theme, CSS custom properties
- **Charts:** Chart.js (bundled as `renderer/chart.umd.min.js`)
- **Build:** electron-builder (NSIS installer for Windows)
- **Auto-update:** electron-updater (GitHub Releases)
- **Tests:** Vitest (`npm test`)

## Architecture

```
Electron Main Process (Node.js)
  ├── main.js              # Window lifecycle, IPC handlers, auto-updater
  ├── lib/wsl-ops.js       # WSL command execution, VHDX discovery, stale scanning, disk usage scanning
  ├── lib/utils.js         # parseWslOutput, friendlyError, exitCodeHint, STALE_DIR_NAMES
  ├── lib/stats-db.js      # Cleanup history persistence (JSON file)
  └── lib/preferences.js   # Task toggle + locale preference persistence

Preload Bridge
  └── preload.js           # contextBridge exposing window.wslCleaner API

Renderer Process (Browser)
  ├── renderer/index.html  # App shell with data-i18n attributes for localization
  ├── renderer/i18n.js     # Lightweight i18n module (t, tp, tError, applyI18n, setLocale)
  ├── renderer/utils.js    # formatBytes, escapeHtml, estimateTotalSize, exitCodeHint
  ├── renderer/tasks.js    # TASKS array (40+ cleanup task definitions)
  ├── renderer/treemap.js  # Squarified treemap layout algorithm & DOM renderer
  ├── renderer/app.js      # All UI logic, state management, task orchestration
  └── renderer/styles.css  # All styling

Locales
  ├── locales/en.json          # Source-of-truth English strings (~200 keys)
  ├── locales/languages.json   # Language registry (codes, names, nativeName)
  └── locales/{code}.json      # Translated locale files (generated by translate script)

Scripts
  ├── scripts/translate.js  # OpenAI-powered translation generator
  └── scripts/release.js    # Version bump helper

CLI
  └── cli.js                  # Standalone CLI (headless, no Electron dependency)

Tests
  ├── tests/main.test.js         # Tests for lib/utils.js functions
  ├── tests/stats-db.test.js     # Tests for lib/stats-db.js persistence
  ├── tests/preferences.test.js  # Tests for lib/preferences.js persistence
  ├── tests/renderer.test.js     # Tests for renderer/utils.js functions
  ├── tests/tasks.test.js        # Tests for task definitions
  ├── tests/cli.test.js          # Tests for CLI parseArgs, stripHtml, formatBytes
  └── tests/i18n.test.js         # Tests for renderer/i18n.js (t, tp, tError)
```

### IPC Pattern

All communication between main and renderer uses Electron's `ipcMain.handle` / `ipcRenderer.invoke` pattern (async request/response). Streaming task output is pushed from main to renderer via `webContents.send('task-output', ...)`.

### Security

- `nodeIntegration: false`, `contextIsolation: true` — never change this
- CSP restricts scripts to `'self'`
- All renderer access to Node/Electron goes through `window.wslCleaner` (preload bridge)
- External URLs validated by `isValidExternalUrl()` before `shell.openExternal()`
- Locale codes sanitized with regex before filesystem access

## File Responsibilities

| File | Purpose |
|------|---------|
| `main.js` | Electron app lifecycle, all IPC handlers, auto-updater events, locale data serving |
| `preload.js` | Exposes `window.wslCleaner` API (WSL ops, preferences, locale, updates) |
| `lib/wsl-ops.js` | `checkWsl`, `detectTools`, `runCleanupTask`, `findVhdx`, `optimizeVhdx`, `scanStaleDirs`, `deleteStaleDirs`, `estimateTaskSizes`, `scanDiskUsage`, `cancelDiskScan` |
| `lib/utils.js` | Pure utility functions: `filterNoise`, `parseWslOutput`, `friendlyError`, `exitCodeHint`, `isValidExternalUrl`, `STALE_DIR_NAMES` |
| `lib/stats-db.js` | Read/write cleanup history to a JSON file in userData |
| `lib/preferences.js` | Read/write task toggles and locale preference to JSON files in userData |
| `renderer/index.html` | Static HTML shell. All user-facing text has `data-i18n` / `data-i18n-html` / `data-i18n-aria` / `data-i18n-title` attributes for localization |
| `renderer/i18n.js` | i18n runtime: `t(key, params)`, `tp(key, count, params)`, `tError(msg)`, `applyI18n()`, `loadLocale(code)`, `setLocale(code)` |
| `renderer/utils.js` | `formatBytes`, `escapeHtml`, `estimateTotalSize`, `exitCodeHint` (returns i18n keys) |
| `renderer/tasks.js` | `TASKS` array with 40+ entries. Each has `id`, `name`, `desc`, `command`, `asRoot`, `requires`, optional `estimateCommand`, optional `aggressive` |
| `renderer/treemap.js` | Squarified treemap layout algorithm and DOM-based renderer. Exposes `window.Treemap` with `buildTree`, `findNode`, `squarify`, `renderTreemap` |
| `renderer/app.js` | All UI logic: navigation, distro picker, task card rendering, cleanup execution, stale scanning, disk compaction, disk map treemap, stats/charts, update checking, language selector |
| `renderer/styles.css` | Full dark-mode stylesheet, custom properties for colors |
| `cli.js` | Standalone CLI for headless/scripted usage (`wsl-cleaner --clean -d Ubuntu`). Exports `parseArgs`, `stripHtml`, `formatBytes` for testing |

## Localization (i18n)

### How It Works

1. **English source of truth:** `locales/en.json` contains all ~200 translatable strings as flat key-value pairs using dot notation (e.g., `"nav.simple"`, `"task.apt-clean.name"`).

2. **Language registry:** `locales/languages.json` defines supported locales:
   - English (`en`), French (`fr`), Mandarin Chinese (`zh`), Hindi (`hi`), Spanish (`es`), Portuguese (`pt`), German (`de`)

3. **Static HTML text** uses `data-i18n` attributes:
   ```html
   <span data-i18n="nav.simple">Simple</span>
   <span data-i18n-html="simple.disclaimer">Text with <strong>HTML</strong></span>
   <button data-i18n-aria="titlebar.minimize" aria-label="Minimize">...</button>
   <div data-i18n-title="simple.cleanOnlyTitle" title="...">...</div>
   ```
   The `applyI18n()` function scans for these and replaces content with translated strings.

4. **Dynamic JS text** uses the `t()` function:
   ```js
   t('status.readyCount', { count: 3 })           // "WSL 2 Ready — 3 distro(s) found"
   tp('stale.found', dirs.length, { count: 5, size: '120 MB' })  // plural-aware
   tError(backendErrorString)                       // reverse-maps English → i18n key
   ```

5. **Task names/descriptions** use computed keys from the task ID:
   ```js
   t('task.' + task.id + '.name')   // e.g., t('task.apt-clean.name')
   t('task.' + task.id + '.desc')   // e.g., t('task.apt-clean.desc')
   ```
   The `TASKS` array in `tasks.js` is NOT modified — English `name`/`desc` remain as fallbacks.

6. **Backend error strings** (from `lib/utils.js` `friendlyError()`) are returned as English text and translated in the renderer via `tError()`, which builds a reverse map from English values to i18n keys at locale load time.

7. **Exit code hints** in `renderer/utils.js` return i18n keys (e.g., `"exitCode.127"`), translated at the call site with `t(hint)`.

8. **Locale preference** is persisted to `{userData}/locale-preference.json` via `lib/preferences.js` and loaded on app startup.

### Key Conventions

- **Flat keys with dot notation:** `"section.subsection.element"` (e.g., `"compact.noVhdx"`, `"log.shuttingDown"`)
- **Plurals:** Use `_one` / `_other` suffixes (e.g., `"stale.found_one"`, `"stale.found_other"`)
- **Placeholders:** `{name}` syntax (e.g., `"Found {count} directories"`)
- **HTML in values:** Allowed and expected for keys with `<code>`, `<strong>`, `<span>` tags. Use `data-i18n-html` in the DOM or set via `innerHTML` in JS.
- **Fallback chain:** Current locale → English (`en.json`) → raw key string
- **What is NOT translated:** Log separator characters (`══`, `──`, `✓`, `✗`), technical identifiers (paths, commands), byte units (`B`, `KB`, `MB`, `GB`, `TB`), Chart.js axis labels

### Adding a New Translatable String

1. Add the key and English value to `locales/en.json`
2. Use `t('your.key')` in JS or `data-i18n="your.key"` in HTML
3. Run `npm run translate` to generate translations for all languages

### Adding a New Language

1. Add an entry to `locales/languages.json`:
   ```json
   { "code": "ja", "name": "Japanese", "nativeName": "日本語" }
   ```
2. Run `npm run translate -- --lang ja`

### Translation Script

`scripts/translate.js` uses the OpenAI API (`gpt-4o-mini`) to translate `en.json` into target languages.

- Reads `OPENAI_API_KEY` from `.env` (gitignored) or the environment
- Reads target languages from `locales/languages.json`
- Incrementally translates only new/missing keys (preserves existing translations)
- Removes stale keys no longer in `en.json`
- Batches large files to stay within token limits
- Instructs the model to preserve HTML tags, placeholders, technical terms, and emoji

```bash
npm run translate              # All languages
npm run translate -- --lang fr # French only
```

## Adding a New Cleanup Task

1. Add the task object to the `TASKS` array in `renderer/tasks.js`:
   ```js
   {
     id: 'my-task',
     name: 'My Task Name',           // English fallback
     desc: 'Description with <code>paths</code>.',
     command: 'bash command here',
     asRoot: true,                    // run as root?
     requires: 'toolname',           // or null if always available
     estimateCommand: 'du -sh ...',  // optional size estimation
     aggressive: false,              // true = off by default, shows warning
   }
   ```
2. Add i18n keys to `locales/en.json`:
   ```json
   "task.my-task.name": "My Task Name",
   "task.my-task.desc": "Description with <code>paths</code>."
   ```
3. Run `npm run translate` to generate translations.
4. If the task requires a new tool, add a detection entry in `lib/wsl-ops.js` `TOOL_CHECKS`.

## Running Tests

```bash
npm test           # Run all tests once
npm run test:watch # Watch mode
```

Tests cover `lib/utils.js` (parsing, error mapping, exit codes), `lib/stats-db.js` (history persistence), `lib/preferences.js` (task prefs and locale), `renderer/utils.js` (formatBytes, escapeHtml, estimateTotalSize), `renderer/tasks.js` (task array validation), `renderer/i18n.js` (t, tp, tError, fallback chain), and `cli.js` (parseArgs, stripHtml, formatBytes).

## Building

```bash
npm run build   # Creates NSIS installer in dist/
```

The `build.files` array in `package.json` includes `locales/**/*` to ensure all locale files are bundled.

## Conventions

- **No frameworks** — vanilla HTML/CSS/JS in the renderer
- **No TypeScript** — plain CommonJS JavaScript throughout
- **`const`/`let`** only, no `var`
- **`async`/`await`** preferred over raw Promise chains
- **Section comments** in large files: `// ── Section Name ──────...`
- **Commit messages:** conventional style (`feat:`, `fix:`, `docs:`, `refactor:`)
- **Security:** never weaken CSP, nodeIntegration, or contextIsolation

## Keeping Documentation in Sync

When making structural changes (adding/removing/renaming files, adding new test files, changing the architecture, adding new cleanup tasks, or modifying how tasks are defined), update **all** of the following:

1. **`AGENTS.md`** — Architecture diagram, File Responsibilities table, Tests listing
2. **`README.md`** — Project Structure section
3. **`CONTRIBUTING.md`** — Project Structure tree, layer/responsibility table, "Adding a New Cleanup Task" instructions, "Running Tests" section

Keep all three in sync so they reflect the same structure and workflow.
